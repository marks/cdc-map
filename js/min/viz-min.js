var MapViz={bug:null,mapPath:"data/us4.json",dataPath:"data/nmaj-nshg.json",us:null,data:null,mapSelector:"#mapViz",sliderSelector:"#mapSlider",mapSVG:null,tooltip:null,YlOrBr:["#ffffe5","#fff7bc","#fee391","#fec44f","#fe9929","#ec7014","#cc4c02","#993404","#662506"],q:null,projection:null,path:null,diseases:null,years:null,methods:["previous_52_weeks_max","previous_52_weeks_med","cum_2015","cum_2016"],disease:"Chlamydia trachomatis infection",year:"2016",week:1,method:"cum_2015",mapLoaded:!1,playing:!1,slider:null,init:function(){d3.select(window).on("resize",MapViz.sizeChange),MapViz.setMap()},setMap:function(){d3.json(MapViz.mapPath,function(e,a){return e?console.error(e):void d3.json(MapViz.dataPath,function(e,t){return e?console.error(e):(MapViz.us=a,MapViz.data=t,MapViz.processData(),MapViz.populateDropDowns(),MapViz.initMap(),void MapViz.animateMap())})})},populateDropDowns:function(){var e=["diseases","years","methods"];_.each(e,function(e){var a=e.slice(0,-1);MapViz[a]=Array.from(MapViz[e])[0]}),_.each(e,function(e){d3.select("#"+e).selectAll("option").data(Array.from(MapViz[e])).enter().append("option").html(function(e){return e}).attr("value",function(e){return e}),$(".selectpicker").selectpicker("refresh"),$("#"+e).on("changed.bs.select",function(a,t){var i=e.slice(0,-1);MapViz[i]=Array.from(MapViz[e])[t],MapViz.drawSlider(),MapViz.sequenceMap(MapViz.disease,MapViz.year,MapViz.week,MapViz.method)})})},initMap:function(){this.projection=d3.geo.albersUsa().scale(1100),this.path=d3.geo.path().projection(this.projection),MapViz.mapSVG=d3.select(this.mapSelector).append("svg").attr("width","100%").append("g"),MapViz.mapSVG.selectAll(".state").data(this.us.features).enter().append("path").attr("class","state").attr("d",this.path),MapViz.tooltip=d3.select("#mapViz").append("div").attr("class","hidden tooltip"),MapViz.colorMap(this.disease,this.year,this.week,this.method),MapViz.drawLengend(),MapViz.drawSlider(),MapViz.sizeChange()},legendKeys:null,drawLengend:function(){var e=d3.select("#legend").append("ul").style("list-style","none");e.append("li").attr("class","key").style("border-left-color","#CCC7C8").text("No Cases Reported");var a=MapViz.q;MapViz.legendKeys=e.selectAll("li.key").data(MapViz.q.range()).enter().append("li").attr("class","key").style("border-left-color",String).text(function(e){var t=a.invertExtent(e);return d3.round(t[0])+" - "+d3.round(t[1])+" cases"})},updateLegend:function(){var e=MapViz.q;MapViz.legendKeys.text(function(a){var t=e.invertExtent(a);return d3.round(t[0])+" - "+d3.round(t[1])+" cases"}),MapViz.playing&&MapViz.legendKeys.transition().duration(1).text(function(a){var t=e.invertExtent(a);return d3.round(t[0])+" - "+d3.round(t[1])+" cases"})},colorMap:function(e,a,t,i){var r=MapViz.getDataRange(e,a,t,i);d3.selectAll(".state").style("fill",function(n){var s=MapViz.getValueFromNest(n.properties,e,a,t,i);MapViz.setCurrentData(n.properties,s,e,a,t,i);var o=MapViz.getColor(s,r);return o}).on("mousemove",function(e){var a=d3.mouse(d3.select("svg g").node()).map(function(e){return parseInt(e)});MapViz.tooltip.classed("hidden",!1).attr("style","left:"+(a[0]+15)+"px; top:"+(a[1]-35)+"px").html("State: "+e.properties.NAME+"<br>Cases: "+e.properties.currentData.value)}).on("mouseout",function(){MapViz.tooltip.classed("hidden",!0)}),MapViz.mapLoaded=!0},sequenceMap:function(e,a,t,i){var r=MapViz.getDataRange(e,a,t,i);d3.selectAll(".state").transition().duration(7).style("fill",function(n){var s=MapViz.getValueFromNest(n.properties,e,a,t,i);MapViz.setCurrentData(n.properties,s,e,a,t,i);var o=MapViz.getColor(s,r);return o}),MapViz.updateLegend()},getColor:function(e,a){if(-1==e|void 0==e)return"#CCC7C8";var t=d3.scale.quantize().domain([a[0],a[1]]).range(MapViz.YlOrBr);return MapViz.q=t,t(e)},getDataRange:function(e,a,t,i){var r=1/0,n=-(1/0),s=1;return d3.selectAll(".state").each(function(s,o){var p=Number(MapViz.getValueFromNest(s.properties,e,a,t,i));r>=p&&-1!=p&&"undefined"!=p&&(r=p),p>=n&&-1!=p&&"undefined"!=p&&(n=p)}),[r,n]},drawSlider:function(){MapViz.mapLoaded&&d3.select(".slider-description").classed("hide",!1),d3.select(MapViz.sliderSelector).remove(),d3.select("#sliderContainer").append("div").attr("id",MapViz.sliderSelector.replace("#",""));var e=MapViz.getWeekRange(MapViz.disease,MapViz.year);d3.select(MapViz.sliderSelector).call(MapViz.slider=d3.slider().axis(!0).min(e[0]).max(e[1]).step(1).on("slide",function(e,a){MapViz.week=a,MapViz.sequenceMap(MapViz.disease,MapViz.year,MapViz.week,MapViz.method)}))},updateSliderTick:function(){MapViz.slider.value(MapViz.week)},getWeekRange:function(e,a){var t=1,i=2;return d3.selectAll(".state").each(function(t,r){var n=MapViz.getMaxWeekFromNest(t.properties,e,a);n>i&&(i=n)}),MapViz.maxWeek=i,[t,i]},sizeChange:function(){d3.select("#mapViz g").attr("transform","scale("+$("#mapViz").width()/900+")"),$("svg").height(.618*$("#mapViz").width()),MapViz.mapLoaded&&MapViz.drawSlider()},processData:function(){MapViz.diseases=new Set,MapViz.years=new Set;var e=_.groupBy(MapViz.data,"reporting_area");for(var a in MapViz.us.features)for(var t in e)featureName=MapViz.us.features[a].properties.NAME,featureName.toLowerCase()==t.toLowerCase()?MapViz.assignDataToFeatureProperty(MapViz.us.features[a].properties,e[t]):"District of Columbia"==featureName&&"DIST. OF COL."==t&&MapViz.assignDataToFeatureProperty(MapViz.us.features[a].properties,e[t])},assignDataToFeatureProperty:function(e,a){var t=_.groupBy(a,"disease");_.each(_.keys(t),function(e){MapViz.diseases.add(e)});var i={};_.each(t,function(e,a){i[a]=_.groupBy(e,"mmwr_year"),_.each(_.keys(i[a]),function(e){MapViz.years.add(e)})});var r={};_.each(i,function(e,a){r[a]="",_.each(e,function(e,t){var i={};i[t]=_.groupBy(e,"mmwr_week"),r[a]=i})}),e.nested_data=r,e.rawdata=a},setCurrentData:function(e,a,t,i,r,n){var s={};s.value=a,s.disease=t,s.year=i,s.week=r,e.currentData=s},getCurrentValue:function(e){return e.currentData.value},getValueFromNest:function(e,a,t,i,r){var n=-1;try{e.nested_data[a][t][i].length>1&&console.log("Warning: There is more than one row for this input combination ->disease: "+a+", year: "+t+", week: "+i),n=e.nested_data[a][t][i][0][r]}catch(s){console.log("DEBUG: The Value doesn't exist for this input combination -> disease: "+a+", year: "+t+", week: "+i+", method: "+r+" Area: "+e.NAME)}if(void 0==n){var n=-1;console.log("DEBUG: The Value doesn't exist for this input combination -> disease: "+a+", year: "+t+", week: "+i+", method: "+r+" Area: "+e.NAME)}return n},getMaxWeekFromNest:function(e,a,t){try{var t=e.nested_data[a][t],i=_.keys(t),r=Number(i.pop());return r}catch(n){return console.log("DEBUG: Weeks don't exist for this input combination -> disease: "+a+", year: "+t+". Error: "+n),1}},animateMap:function(){var e;d3.select("#play").on("click",function(){0==MapViz.playing?(e=setInterval(function(){MapViz.week<MapViz.maxWeek?MapViz.week+=1:MapViz.week=1,MapViz.sequenceMap(MapViz.disease,MapViz.year,MapViz.week,MapViz.method),MapViz.updateSliderTick()},500),d3.select(this).html("Stop"),MapViz.playing=!0):(clearInterval(e),d3.select(this).html("play"),MapViz.playing=!1)})}};window.onload=MapViz.init();